<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <record id="paperformat_japan_lowmargin" model="report.paperformat">
        <field name="name">Japan A4 low margin</field>
        <field name="default" eval="True"/>
        <field name="format">A4</field>
        <field name="page_height">0</field>
        <field name="page_width">0</field>
        <field name="orientation">Portrait</field>
        <field name="margin_top">8</field>
        <field name="margin_left">5</field>
        <field name="margin_right">5</field>
        <field name="header_line" eval="False"/>
        <field name="header_spacing">20</field>
        <field name="dpi">80</field>
    </record>
    <report
            id="report_monthly_invoice_print"
            model="account.move"
            report_type="qweb-pdf"
            string="月次請求書"
            name="monthly_invoice.report_monthly_invoice_print"
            file="monthly_invoice.report_monthly_invoice_print"
            paperformat="monthly_invoice.paperformat_japan_lowmargin"
    />
    <template id="report_monthly_invoice_print">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="doc">
                <t t-call="web.internal_layout" style="margin-top: 1px; padding-top: 0px;">
                    <div class="container" style="margin-top: 1px; padding-top: 0px;">
                        <div class="row" style="margin-top: 1px; padding-top: 0px;">
                            <div class="col-7">
                                <div style="padding-left:15px;margin-left:15px;">
                                    <div style="font-size:14px;font-weight:10;">
                                        <span t-esc="doc.partner_id.zip"/>
                                        <br/>
                                        <span t-esc="doc.partner_id.state_id.name"/>
                                        <span t-esc="doc.partner_id.city"/>
                                        <span t-esc="doc.partner_id.street"/>
                                        <br/>
                                        <span t-esc="doc.partner_id.street2"/>
                                    </div>
                                    <div>
                                        <strong><span><t t-esc="str(doc.partner_id.name) + '　　御中' if doc.partner_id.is_company else str(doc.partner_id.name) +' 様'"/></span></strong>
                                    </div>
                                </div>
                                <div style="font-size:12px;">
                                    <p style="padding-top:50px;">
                                        件名: <span t-esc="doc._get_subject(doc.monthly_invoices)"/>
                                    </p>
                                    <p>
                                        下記の通りご請求致しますのでお支払い下さいますようお願い申し上げます。
                                    </p>
                                    <h4 style="background-color:black; color: white; text-align:center">御 請 求 書</h4>
                                    <br/>
                                </div>
                                <table class="table table-sm table-bordered" style="width: 80%; font-size: 15px">
                                    <tr>
                                        <td><span t-esc="doc.invoice_date.month"/>月御請求金額
                                        </td>
                                        <td class="text-right">¥
                                            <span t-esc="'{0:,}'.format(round(doc.monthly_sum_with_tax))" />
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>小 計
                                        </td>
                                        <td class="text-right">¥
                                            <span t-esc="'{0:,}'.format(round(doc.monthly_sum_without_tax))" />
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>消費税
                                        </td>
                                        <td class="text-right">¥
                                            <span t-esc="'{0:,}'.format(round(doc.monthly_tax))" />
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>合 計
                                        </td>
                                        <td class="text-right">¥
                                            <span t-esc="'{0:,}'.format(round(doc.monthly_sum_with_tax))" />
                                        </td>
                                    </tr>
                                </table>
                            </div>
                            <div class="col-5">
                                <table class="float-right" style="width: 80%; font-size: 13px;">

                                    <tr>
                                        <td class="text-right">発行日:
                                            <span t-esc="doc.invoice_date.year"/>/
                                            <span t-esc="doc.invoice_date.month"/>/
                                            <span t-esc="doc.last_working_day_of_month(doc.invoice_date.year, doc.invoice_date.month)"/>
                                        </td>

                                    </tr>
                                    <tr>
                                        <td class="text-right">ご請求No: FPS49 -
                                            <span t-esc="str(doc.partner_id.vat)[4:]"/><span t-esc="str(doc.invoice_date.year)[2:]"/><span t-esc="doc._get_month(doc.invoice_date.month)"/>
                                        </td>
                                    </tr>
                                </table>
                                <br/>
                                <br/>
                                <p class="float-right">
                                    <span class="bold-name" style="font-size:15px; font-weight: bold !important;"><t t-esc="doc.company_id.name"/></span>
                                    <br/>
                                    <span style="font-size:11px;" t-esc="doc.company_id.zip"/>
                                    <br/>
                                    <span style="font-size:11px;" t-esc="doc.company_id.state_id.name"/>
                                    <span style="font-size:11px;" t-esc="doc.company_id.city"/>
                                    <span style="font-size:11px;" t-esc="doc.company_id.street"/>
                                    <span style="font-size:11px;" t-esc="doc.company_id.street2"/>
                                </p>
                                <style>
                                    .inkan {
                                    width:80%;
                                    padding-top: 10px;
                                    }
                                    .inkantd {
                                    width:30%;
                                    position:relative;
                                    border: solid 1px;
                                    }
                                    .inkantd:after{
                                    content:'';
                                    display:block;
                                    margin-top:100%;
                                    }
                                    .inkantd .content {
                                    position:absolute;
                                    top:0;
                                    bottom:0;
                                    left:0;
                                    right:0;
                                    }
                                </style>
                                <p>
                                    <div style="font-weight: 10; font-size:10px; float: left">
                                        ※ 誠に恐れ入りますが上記代金を下記口座にお振込願います。
                                        <br/>
                                        三井住友銀行 世田谷支店 当座 No.0267088
                                        <br/>
                                        三菱UFJ銀行 渋谷中央支店 当座 No.0663058
                                        <br/>
                                        みずほ銀行 世田谷支店 当座 No.0110241
                                        <br/>
                                        三菱UFJ銀行 駒沢大学駅前支店 当座 No.0144789
                                        <br/>
                                        りそな銀行 渋谷支店 当座 No.0513734
                                    </div>
                                </p>
                                <br/>
                                <table class="inkan">
                                    <tr>
                                        <td class="inkantd">
                                            <div class="content"></div>
                                        </td>
                                        <td class="inkantd">
                                            <div class="content"></div>
                                        </td>
                                        <td class="inkantd">
                                            <div class="content"></div>
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                    <br/>
                        <table class="table table-sm table-bordered" style="font-size: 15px">
                            <tr>
                                <td>商品名</td>
                                <td class="text-center">数量</td>
                                <td class="text-center">小計</td>
                            </tr>
                            <t t-foreach="doc._compute_monthly_with_group()" t-as="line_group">
                                <tr>
                                    <td><span t-esc="line_group['product_id'][1] if line_group['product_id'] else 'N/A'"/></td>
                                    <td class="text-right"> <span t-esc="'{0:,}'.format(round(line_group['quantity']))"/></td>
                                    <td class="text-right"> <span t-esc="'{0:,}'.format(round(line_group['price_total']))"/></td>
                                </tr>
                            </t>
                        </table>
                    <div style="page-break-before: always;"/>
                    <h5>ご請求明細</h5>
                    <table class="table table-sm table-bordered o_main_table" name="monthly_invoice_line_table">
                        <thead>
                            <tr>
                                <th name="th_date" class="text-center">
                                    <span style="font-weight: 10; font-size:11px;">納品日</span>
                                </th>
                                <th name="th_delivery_address" class="text-center">
                                    <span style="font-weight: 10; font-size:11px;">納品先</span>
                                </th>
                                <th name="th_description" class="text-center">
                                    <span style="font-weight: 10; font-size:11px;">製品名</span>
                                </th>

                                <th name="th_unit_price" class="text-center">
                                    <span style="font-weight: 10; font-size:11px;">単価</span>
                                </th>
                                <th name="th_quantity" class="text-center">
                                    <span style="font-weight: 10; font-size:11px;">数量</span>
                                </th>
                                <th name="th_total_without_tax" class="text-center">
                                    <span style="font-weight: 10; font-size:11px;">金額</span>
                                </th>
                                <th name="th_client_order_number" class="text-center">
                                    <span style="font-weight: 10; font-size:11px;">備考</span>
                                </th>
                            </tr>
                        </thead>
                        <tbody class="invoice_tbody">
                            <t t-set="lines" t-value="doc.monthly_invoices.sorted(key=lambda l: l._get_order_data('scheduled_date'))"/>
                            <t t-set="counter" t-value="0"/>
                            <t t-foreach="lines" t-as="line">
                                <tr>
                                    <td name="order_date" class="text-center">
                                        <span t-esc="line._get_order_data('scheduled_date')" t-options="{'widget': 'date'}" style="font-weight: 10; font-size:10px;"/>
                                    </td>
                                    <td name="delivery_address" class="text-left" style="font-weight: 10; font-size:10px;">
                                        <span t-esc="line.move_id.partner_shipping_id.name"
                                                 t-options='{"widget": "text"}'/>
                                    </td>
                                    <td name="description" class="text-left">
                                        <span t-field="line.product_id.name" t-options="{'widget': 'text'}" style="font-weight: 10; font-size:10px;"/>
                                    </td>
                                    <td name="price_unit" class="text-right" style="font-weight: 10; font-size:10px;">
                                        <span t-esc="'{0:,}'.format(round(line.price_unit))"/>
                                    </td>
                                    <td name="quantity" class="text-right" style="font-weight: 10; font-size:12px;">
                                        <span t-esc="'{0:,}'.format(round(line.quantity))"/>
                                    </td>
                                    <!--
                                    TODO Add here a tax column because the title says so,
                                    the tax is going to be equal to price_subtotal - price_unit
                                    -->
                                    <td name="price_subtotal" class="text-right" style="font-weight: 10; font-size:10px;">
                                        <span t-esc="'{0:,}'.format(round(line.price_subtotal))"/>
                                    </td>
                                    <td name="order_client_number" class="text-center">
                                        <span t-esc='line._get_order_data("client_order_ref")'
                                              t-options="{'widget': 'text'}" style="font-weight: 10; font-size:10px;"/>
                                    </td>
                                </tr>
                                <t t-set="counter" t-value="counter+1"/>
                                <t t-if="counter >= 15 and counter % 15 == 1">
                                    <div style = "page-break-inside:avoid;"/>
                                </t>
                            </t>
                        </tbody>
                    </table>
                <div class="footer">
                  <div class="row">
                      <div class="col-6"></div>
                      <div class="col-6" style="padding:0px;">
                          <p><span class="page" /> / <span class="topage" /></p>
                      </div>
                  </div>
                </div>
                </t>
            </t>
        </t>
    </template>
</odoo>
